// Prisma Schema for Spin the Wheel Application
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tenant represents a business account (restaurant, store, etc.)
model Tenant {
  id              String   @id @default(uuid())
  name            String   // Business name
  ownerName       String
  email           String   @unique
  password        String   // Hashed password
  firebaseUid     String?  // Firebase User ID for social login
  isOwner         Boolean  @default(false) // Platform owner flag
  status          String   @default("Active") // Active, Trial, Suspended
  logo            String?
  primaryColor    String   @default("#2bbdee")
  secondaryColor  String   @default("#1e293b") // Secondary accent color
  backgroundColor String   @default("#f8fafc") // Background color
  textColor       String   @default("#0f172a") // Text color
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  prizes          Prize[]
  users           User[]
  spinConfig      SpinConfiguration[]
  spinHistory     SpinHistory[]
  contactRequests ContactRequest[]
  projects        Project[]
  prizeTemplates  PrizeTemplate[]
  prizeHistorySnapshots PrizeHistorySnapshot[]

  @@map("tenants")
}

// Prize configured by tenant
model Prize {
  id          String   @id @default(uuid())
  tenantId    String
  projectId   String?  // Optional: prizes can belong to specific projects
  name        String
  type        String   // Food Item, Discount, Merchandise, Voucher
  description String
  status      String   @default("Active") // Active, Inactive
  
  // Prize Image
  imageUrl    String?  // Custom uploaded image URL
  iconType    String?  // Generic icon: gift, discount, food, voucher, etc.
  
  // Quantity Management
  isUnlimited        Boolean  @default(true)  // If true, prize is always available
  quantity           Int?     // Current available quantity (null for unlimited)
  initialQuantity    Int?     // Original quantity for analytics
  exhaustionBehavior String   @default("exclude") // "exclude", "show_unavailable", "mark_inactive"
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([tenantId, projectId, name])
  @@map("prizes")
}

// End users who spin the wheel (customers)
model User {
  id         String   @id @default(uuid())
  tenantId   String
  name       String
  email      String
  avatar     String?
  plan       String   @default("Basic") // Basic, Premium
  status     String   @default("Active") // Active, Inactive, Pending
  dateJoined DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@map("users")
}

// Spin wheel customization per tenant
model SpinConfiguration {
  id                String   @id @default(uuid())
  tenantId          String
  projectId         String?  @unique // Each project can have one config
  wheelColors       String[] // Array of color codes
  spinDuration      Int      @default(5000) // milliseconds
  soundEnabled      Boolean  @default(true)
  showConfetti      Boolean  @default(true)
  customMessage     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project           Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("spin_configurations")
}

// Record of all spins
model SpinHistory {
  id              String   @id @default(uuid())
  tenantId        String
  projectId       String?  // Optional: track which project this spin belongs to
  userName        String?  // Name of person who spun
  userEmail       String?  // Email of person who spun
  userPhone       String?  // Phone of person who spun
  prizeWon        String   // Name of prize won
  timestamp       DateTime @default(now())
  
  // Redemption fields for booth mode
  redemptionToken String?  @unique // Token for QR code redemption
  isRedeemed      Boolean  @default(false) // Whether prize has been redeemed
  redeemedAt      DateTime? // When the prize was redeemed

  // Relations
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project    Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("spin_history")
}

// Contact requests for custom experiences
model ContactRequest {
  id                String   @id @default(uuid())
  tenantId          String?  // Optional - for logged-in users, null for public inquiries
  name              String
  email             String
  phone             String?
  message           String
  requestType       String   // New Experience, Customization, Support
  status            String   @default("Pending") // Pending, In Review, Quoted, Accepted, Rejected
  estimatedCost     Float?
  estimatedTimeframe String?
  adminNotes        String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  tenant            Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@map("contact_requests")
}

// Project/Event model for the Agency workflow
model Project {
  id          String    @id @default(uuid())
  tenantId    String
  name        String    // e.g. "Summer Trade Show 2025"
  slug        String?   // Optional URL-friendly identifier
  
  // Status & Workflow
  status      String    @default("Draft") // Draft, Quoted, PendingPayment, Active, Completed, Archived
  isPaid      Boolean   @default(false)
  price       Float?    // The quoted price for this project
  
  // Event Constraints
  startDate   DateTime? // When the event starts
  endDate     DateTime? // When the event ends
  spinLimit   Int?      // Maximum total spins allowed for project
  currentSpins Int      @default(0) // Current spin count
  
  // User Spin Settings
  requireContact     Boolean @default(true)  // Require email/phone before spin
  enableSpinLimit    Boolean @default(true)  // Restrict repeat spins by user
  spinsPerUserPerDay Int     @default(1)     // Number of spins per user per day (0 = unlimited)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  spinConfig  SpinConfiguration?
  prizes      Prize[]
  spinHistory SpinHistory[]

  @@map("projects")
}

// Prize Template for reusable configurations
model PrizeTemplate {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // Template name
  description String?  // Optional description
  prizes      Json     // Array of prize objects (snapshot)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@map("prize_templates")
}

// Prize History Snapshot for tracking changes
model PrizeHistorySnapshot {
  id          String   @id @default(uuid())
  tenantId    String
  projectId   String?
  prizes      Json     // Array of prize objects at this point
  action      String   // "created", "modified", "imported", "deleted"
  description String?  // Optional note
  createdAt   DateTime @default(now())

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("prize_history_snapshots")
}

